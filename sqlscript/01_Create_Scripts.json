{
	"name": "01_Create_Scripts",
	"properties": {
		"folder": {
			"name": "Creation Scripts"
		},
		"content": {
			"query": "-- Check if the database 'nyc_taxi_ldw' does exisT, then first drop the db.\n\nIF EXISTS(SELECT * FROM sys.databases WHERE name = 'nyc_taxi_ldw')\n    BEGIN\n        DROP DATABASE nyc_taxi_ldw\n    END\n\nGO\n\n-- Check if the database 'nyc_taxi_ldw' does not exist, create the db.\nIF NOT EXISTS(SELECT * FROM sys.databases WHERE name = 'nyc_taxi_ldw')\n    BEGIN\n        CREATE DATABASE nyc_taxi_ldw\n    END\n\nGO\n\n-- Check if the 'nyc_taxi_ldw' database exists and then alter the schema to add right collation to the database utf-8.\nIF EXISTS(SELECT * FROM sys.databases WHERE name = 'nyc_taxi_ldw')\nBEGIN\n    Alter DATABASE nyc_taxi_ldw COLLATE Latin1_General_100_CI_AI_SC_UTF8\nEND\nGo\n\n\n-- Create external data source in nyc_taxi_ldw\nUSE nyc_taxi_ldw\nGO\n\n-- Check if the 'bronze' schema exists\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'bronze')\nBEGIN\nEXEC ('CREATE SCHEMA bronze')\nEND\nGO\n\n-- Check if the 'silver' schema exists\nIF NOT EXISTS (SELECT name FROM sys.schemas WHERE name = 'silver')\nBEGIN\n    EXEC ('CREATE SCHEMA silver')\nEND\nGO\n\n-- Check if the 'gold' schema exists\nIF NOT EXISTS (SELECT name FROM sys.schemas WHERE name = 'gold')\nBEGIN\n    EXEC ('CREATE SCHEMA gold')\nEND\nGO\n\n-- Create the external data source pointing to ADLS\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'nyc_data_raw')\nCREATE EXTERNAL DATA SOURCE nyc_data_raw\nWITH\n(\n    Location = 'https://devsynapseaccount01.dfs.core.windows.net/nyc-taxi-dataset'\n)\nGO\n\n-- Create the external file format pointing to ADLS\n\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'csv_file_formats')\nCREATE EXTERNAL FILE FORMAT csv_file_formats\nWITH\n(\n    FORMAT_TYPE = DELIMITEDTEXT,\n    FORMAT_OPTIONS(\n        FIELD_TERMINATOR = ','\n        ,STRING_DELIMITER = '\"'\n        ,FIRST_ROW = 2\n        ,USE_TYPE_DEFAULT = FALSE\n        ,ENCODING = 'UTF8'\n        ,PARSER_VERSION = '2.0'\n    )\n)\nGO\n\n-- Create the external file format pointing to ADLS for PARSER_VERSION 1.0\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'csv_file_formats_pv1')\nCREATE EXTERNAL FILE FORMAT csv_file_formats_pv1\nWITH\n(\n    FORMAT_TYPE = DELIMITEDTEXT,\n    FORMAT_OPTIONS(\n        FIELD_TERMINATOR = ','\n        ,STRING_DELIMITER = '\"'\n        ,FIRST_ROW = 2\n        ,USE_TYPE_DEFAULT = FALSE\n        ,ENCODING = 'UTF8'\n        ,PARSER_VERSION = '1.0'\n    )\n)\nGO\n\n-- create the external taxi zone table.\nIF OBJECT_ID('bronze.taxi_zone') is NOT NULL\n    DROP EXTERNAL TABLE bronze.taxi_zone\nGO\nCREATE EXTERNAL TABLE bronze.taxi_zone\n(\n    location_id SMALLINT,\n    brough VARCHAR(15),\n    zone VARCHAR(50),\n    service_zone VARCHAR(15)\n\n)\nWITH (\n    LOCATION = 'raw/taxi_zone.csv',\n    DATA_SOURCE = nyc_data_raw,\n    FILE_FORMAT = csv_file_formats,\n    REJECT_VALUE = 1,\n    REJECTED_ROW_LOCATION = 'rejections/taxi_zone'\n)\nGO\n\n\n\nIF OBJECT_ID('bronze.calendar') is NOT NULL\n    DROP EXTERNAL TABLE bronze.calendar\nGO\n\n-- create the external calendar table.\nCREATE EXTERNAL TABLE bronze.calendar\n(\n        date_key INT,\n        date date,\n        year smallint,\n        month smallint,\n        day smallint,\n        day_name varchar(15),\n        day_of_year smallint,\n        week_of_month smallint,\n        week_of_year smallint,\n        month_name VARCHAR(15)\n)\nWITH (\n    LOCATION = 'raw/calendar.csv',\n    DATA_SOURCE = nyc_data_raw,\n    FILE_FORMAT = csv_file_formats,\n    REJECT_VALUE = 1,\n    REJECTED_ROW_LOCATION = 'rejections/calendar'\n)\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "nyc_taxi_ldw",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}